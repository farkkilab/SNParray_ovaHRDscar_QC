# SNParray_ovaHRDscar_QC
Script for calculating ovaHRDscar from LogRatio files and BAF files produced with GenomeStudio

## Getting started

### Requirements

- R 4.2.3
- R packages:
  - usethis
  - devtools
  - dplyr
  - ggrepel
  - ovaHRDscar (https://github.com/farkkilab/ovaHRDscar)

In addition you would need ASCAT v3.1.2. This version is stored in our datacloud: https://datacloud.helsinki.fi/index.php/f/54077565
To install this ASCAT version do the next:
1. Download the ascat-master.zip file
2. Decompress the file
3. In case you have another version of ASCAT already installed, uninstall that ASCAT version you have.
4. Install this ASCAT version from R studio in the next way, just replace YOURPATH for your own computer path where you decompressed the ascat-master.zip file.

```
library(devtools)
install_local("YOURPATH/ascat-3.1.2/ascat-3.1.2/ASCAT/", force = TRUE)
```

### Input files

**1. LogR ratio files and BAF files from GenomeStudio:**

From Illumina-SNP arrays raw data the LogR ratio and BAF files can be generated using the Genome Studio software ([link](https://www.illumina.com/techniques/microarrays/array-data-analysis-experimental-design/genomestudio.html)).

Here there is a tutorial about how to prepare a Genome Studio project: <https://www.youtube.com/embed/s23379Gya0Y?autoplay=1&rel=0>

Once that the project is setup and the call rates have been generated, next select the columns necessary for this script and export those in a text file. Here is a tutorial that describe how to select the columns: [link](http://penncnv.openbioinformatics.org/en/latest/user-guide/input/#preparing-input-signal-intensity-files-from-beadstudio-project-files)

Also here there is information about how  to generate the input files: https://docs.google.com/document/d/1mXT1G87VnemVMd0mZsD9MbP4VigF6vtQ/edit

Example of input LogRratio file:

```
Name	Chr	Position	206064570174_R01C01.Log R Ratio	206064570174_R01C02.Log R Ratio	206064570174_R02C01.Log R Ratio	206064570174_R02C02.Log R Ratio
IlmnSeq_17:43099552_IlmnFwd	1	0	0.7191634	1.232309	0.6488559	0.7817191
IlmnSeq_17:43099552_IlmnFwd_IlmnDup	1	0	0.8655574	1.179978	0.7319136	0.8444639
rs9701055	1	630053	0.3893069	0.5379636	0.3871996	0.4364024
rs9651229	1	632287	0.4435982	0.9377586	0.5331625	0.6015976
```

Importantly the first three columns must have the names: Name	Chr	Position followed by the samples with suffix either Log.R.Ratio or B.Allele.Freq

**2. Call rates for each sample generated with GenomeStudio:**

Call rates in table format should be generated with GenomeStudio for each sample analyzed in the SNP array. 

Here there is information about how  to generate the input files: https://docs.google.com/document/d/1mXT1G87VnemVMd0mZsD9MbP4VigF6vtQ/edit

Example of call rate table:

```
Index	Sample ID	Call Rate	Gender	p05 Grn	p50 Grn	p95 Grn	p05 Red	p50 Red	p95 Red	p10 GC	p50 GC	Rep Error Rate	PC Error Rate	PPC Error Rate	Aux	Genotype	Score	Subset	Array Info.Sentrix ID	Array Info.Sentrix Position
1	206064570174_R01C01	0,7841907	Unknown	146	1103	6967	423	1383	18108	0,3586062	0,7817292	 	 	 	0		0,00		206064570174	R01C01
2	206064570174_R01C02	0,6686158	Unknown	144	756	6521	417	1123	16369	0,308951	0,7615124	 	 	 	0		0,00		206064570174	R01C02
3	206064570174_R02C01	0,8841922	Unknown	148	1391	7006	464	1684	18739	0,4001076	0,8107659	 	 	 	0		0,00		206064570174	R02C01
4	206064570174_R02C02	0,7895314	Unknown	143	1083	6872	459	1423	18164	0,3614593	0,7856024	 	 	 	0		0,00		206064570174	R02C02
```

Importantly the table must contain the next column names: Index, Sample ID, Call Rate.


**3. Sample sheet in csv format:**
A file that related the sample names with sample IDs used in the SNP array. This file is usually generated by SNP array facilities to be used by GenomeStudio. Format the file to be csv format and compatible with R.
This is an example of file:
```
Sample_ID	SentrixBarcode_A	SentrixPosition_A	SentrixBarcode_B	SentrixPosition_B	Sample_Plate	Sample_Well	Sample_Group	Gender	Sample_Name	Replicate	Parent1	Parent2
ONC.A01_HUS23_ONC_TEGE	2.06E+11	R01C01			HUS_ONCOSYS_2023	A01	not_specified	Unknown	S220_pAdnL_HUS_FFPE		 	 
ONC.C01_HUS23_ONC_TEGE	2.06E+11	R01C02			HUS_ONCOSYS_2023	C01	not_specified	Unknown	S091_pUmbilicus_HUS_a		 	 
ONC.B01_HUS23_ONC_TEGE	2.06E+11	R02C01			HUS_ONCOSYS_2023	B01	not_specified	Unknown	S046_iOme_HUS_FFPE		 	 
ONC.D01_HUS23_ONC_TEGE	2.06E+11	R02C02			HUS_ONCOSYS_2023	D01	not_specified	Unknown	S091_iOme_HUS_b		
```

Importantly the table must contain the next column names: Sample_ID, Sample_Name.


**4. GCcontent_GSAv3.txt**

File for ASCAT, generated with the ASCAT's script `createGCcontentFile.R`
For each new type of SNP array a new GC content file must be created. Read carefully ASCAT instructions.

The current file `GCcontent_GSAv3.txt` is for Illumina GSA v3 SNP arrays created by Fernando using the next instructions by ASCAT:
https://github.com/VanLoo-lab/ascat/tree/master/LogRcorrection

**5. ReplicationTiming_GSAv3.txt**

File for ASCAT, generated with the ASCAT's script `createReplicTimingFile.R`
For each new type of SNP array a new replication timing correction file file must be created. Read carefully ASCAT instructions.

The current file `ReplicationTiming_GSAv3.txt` is for Illumina GSA v3 SNP arrays created by Fernando using the next instructions by ASCAT:
https://github.com/VanLoo-lab/ascat/tree/master/LogRcorrection

### Input variables


Inside the script set the next variables:
- **SNParray**: This is a variable for ASCAT to calibrate the signals. Currently the variable in the script is set to `IlluminaGSAv3` as this is the SNParray we have used most commonly. Other options by ASCAT are also:

```
Custom10k, IlluminaASA, IlluminaGSAv3, Illumina109k, IlluminaCytoSNP, IlluminaCytoSNP850k, Illumina610k, Illumina660k, Illumina700k, Illumina1M, Illumina2.5M, IlluminaOmni5, IlluminaOmniExpressExome, IlluminaGDACyto-8, Affy10k, Affy100k, Affy250k_sty, Affy250k_nsp, AffyOncoScan, AffyCytoScanHD, AffySNP6, HumanCNV370quad, HumanCore12, HumanCoreExome24 and HumanOmniExpress12.
```

Take a look at ASCAT instructions for other current options.


- **Suffix**: This variable will be used to name all output files.

## Setting your script for run

Firstly. Create a project folder that will allocate all your input files. Create a project folder for each batch of samples analyzed. Input files in the project folder should be:
 1. *LogRratio_samples.txt* - See above, file generated with GenomeStudio
 2. *BAF_samples.txt* - See above, file generated with GenomeStudio
 3. *Sample_sheet.csv*
 4. *Samples_QC.txt*

You don't need to have in  the same folder the GCcorrectionfile and ReplicationTiming, just give the full path to where this files are.

Clone this repository or download the scripts. 

The main script for running the analysis is: **ASCAT3_QCs_ovaHRDscars_onlyTumor.R**. Inside this script adjust the next variables in the first block of the script according to the location of your input files:

- *repo.path* - #Add the path where you have this repository SNParray_ovaHRDscar_QC (scripts) cloned

Also the next variables inside the script:
```
#This is the folder where you have all the files LogR, BAF
#In this folder a new folder will be created with results
Project_folder <- "D:/users/fperez/SNP-arrays_results/Oncosys_and_others/20250515_Tartu_PARP/"

#The next block of files must be inside the Project_folder!!

#Name for LogRratio and BAF autosome files
Tumor_LogR_pre <- "LogRratio_samples.txt"
Tumor_BAF_pre <- "BAF_samples.txt"

#Sample sheet file with the Sample_ID (arrayIDs) in the first column, and samples names under the column Sample_Name, this file is generated for every SNParray batch it should be in CSV format
samplesheet <- "Sample_sheet.csv"

#Callrate values generated by genomeStudio
callrates <- "Samples_QC.txt"

#GCcorrection file, is a file for each SNParray, was generated using the LogRcorrection module that is part of ASCAT3
#Those files are already generated by Fer an ready to use in a folder
#These files are not needed to be in Project_folder
GCcorrectionfile <- "D:/users/fperez/SNP-arrays_results/Utils/GCcontent_GSAv3.txt"
ReplicationTiming <- "D:/users/fperez/SNP-arrays_results/Utils/ReplicationTiming_GSAv3.txt"

#Next variable is important for calibration with ASCAT, it referst to the type of SNP-array used
#Other common options: "IlluminaGSAv3", "IlluminaGSAv2", "AffyCytoScanHD"
SNParray <- "IlluminaGSAv3"
#Check inside /mnt/d/users/fperez/HRD/SNP_Arrays/ascat-master/ASCAT/R for more SNP array options

#Outputfiles suffix, the most relevant is the ASCAT_segments file, this is the input for the HRDscar script
Suffix <- "PARP_2025May"
```

## Running the script

After setting up the previous variables. Just run all the script. The script has some checks, for example if some of the files have the correct column names.
The script will be printing status of the process.

## Outputs

### Intermediate files

In the second block of the script, the LogR and BAF files will be proccesed to only select autosomes and sort them by position. The next two files will be generated that will be input for ASCAT:
1. BAF_samples_autosomes.txt
2. LogRratio_samples_autosomes.txt

In the third block of the script A folder `ASCAT/` will be generated with all the intermediate files from ASCAT. This includes:
 1. Raw BAF plots
 2. BAF plots after QC correction to detect heterocigous SNPs
 3. BAF plots with the segmentation (cnv detection)
 4. Table with list of allele specific copy number per sample (ASCAT_segments_Suffix.txt)
 5. Table with stimated purity per sample
 6. Table with stimated ploidy per sample

In the fifth block of the script a the HRDscar calculation will be performed and the next two interemediate files will be generated, one with ovaHRDscar metrics and another with Telli et al, 2016 metrics:
1. Telli_scars_Suffix.txt
2. ovaHRDscars_Suffix.txt

In the sixth block of the script a Median of the Absolute values of all Pairwise Differences (MAPD) calculation will be generated using the LogRratio_samples_autosomes.txt as input. A file with MAPD per sample will be generated `MAPD_PARP_Suffix.txt`.

More about MAPD in the next site: [link](https://assets.thermofisher.com/TFS-Assets/LSG/brochures/mapd_snp6_whitepaper.pdf)

In the seventh block, all intermediate files will be merged.

### Final result file

After all intermediate files get merged, a final file `QC-scars-info_Suffix.csv` will be generated.

Example of final file:

```
name	MAPD	Sample_Name	Call.Rate	nLOH	LSTs	nTAIs	ovaHRDscar	Telli.LOH	Telli.LSTs	Telli.nTAIs	Telli.HRDsum	ASCAT.ploidy	ASCAT.purity
P1	0.763	NA	0.7819392	11	17	21	49	16	21	21	58	1.88	0.63
P10	0.618	NA	0.8536346	25	19	20	64	28	25	20	73	1.59	0.7
P11	0.819	NA	0.8002526	7	5	8	20	13	6	8	27	1.75	0.38
P12	0.71	NA	0.8693979	0	0	8	8	0	0	8	8	1.95	0.43
```

Description of columns in resultant file:

- *name* : Sample_ID extracted from the file `Sample_sheet.csv`
- *MAPD* : MAPD values in the LogR files
- *Call.Rate* : Call rate assessed with GenomeStudio for each sample and listed in the file `Samples_QC.txt`
- Then three columns with nLOH, LSTs and TAIs per sample according to ovaHRDscar criteria
- Then three columns with nLOH, LSTs and TAIs per sample according to Telli et al, 2016 criteria
- The sample ploidy infered by ASCAT
- The sample purity infered by ASCAT

## Description of scripts in this repository

1. `ASCAT3_QCs_ovaHRDscars_onlyTumor.R` - Master R script to run all the ASCAT, MAPD calculation, ovaHRDscar analysis.

2. `functions_QC_BAF_LOG.R` - An R script with functions that are used internally by the script *ASCAT3_QCs_ovaHRDscars_onlyTumor.R*

3. `select-Autosomes.sh` - An archival bash (shell) script to proccess the LogRatio and BAFfiles, this script is not longer needed in the analysis.

4. `LTS_normalization.R` - Script for calculating normalized LSTs according to Christinat, Yann, et al. JCO Precision Oncology 2023. This script takes as input the resultant file `QC-scars-info_*.csv` generated by the script **ASCAT3_QCs_ovaHRDscars_onlyTumor.R**
